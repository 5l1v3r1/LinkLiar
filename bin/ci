#!/usr/bin/env bash

# Decrypt Developer Certificate
openssl aes-256-cbc -k "$CERTIFICATE_ENCRYPTION_KEY" -in master_chief.cer.enc -d -a -out master_chief.cer
openssl aes-256-cbc -k "$CERTIFICATE_ENCRYPTION_KEY" -in master_chief.p12.enc -d -a -out master_chief.p12

# Create custom keychain
security create-keychain -p $CUSTOM_KEYCHAIN_PASSWORD linkliar.keychain

# Make the linkliar.keychain default, so xcodebuild will use it
security default-keychain -s linkliar.keychain

# Unlock the keychain
security unlock-keychain -p $CUSTOM_KEYCHAIN_PASSWORD linkliar.keychain

# Set keychain timeout to 1 hour
security set-keychain-settings -t 3600 -l ~/Library/Keychains/linkliar.keychain

security import master_chief.cer -k linkliar.keychain -A
security import master_chief.p12 -k linkliar.keychain -P $CERTIFICATE_PROTECTION_KEY -A

# Fix for OS X Sierra that hangs in the codesign step
security set-key-partition-list -S apple-tool:,apple: -s -k $CERTIFICATE_PROTECTION_KEY linkliar.keychain > /dev/null
